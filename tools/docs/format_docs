#!/usr/bin/env ruby

# This file contains code to massage docs files from a repository to fit on the web

require 'yaml'

def update_docs_content(docs_dir, ns, repo_name)
  Dir.glob(File.join(docs_dir, '*.md')).each do | file|
    doc = IO.read(file)
    doc_fm = update_front_matter_data(doc, ns, repo_name)
    result = update_urls(doc_fm, repo_name)
    IO.write(file, result)
  end
end

def update_front_matter_data(doc, ns, repo_name)
  data = YAML.load(doc)
  data['page_id'] = ns + data['page_id']
  data['layout'] = 'page-docs'
  data['repo_name'] = repo_name
  data['ns'] = ns

  start_of_front_matter = doc.index('---')
  end_of_front_matter = doc.index('---', start_of_front_matter + 3)
  data.to_yaml + doc[end_of_front_matter..-1]
end

def update_urls(doc, repo_name)
  # The URLs in the repo docs are designed to work with the local jekyll server,
  # massage them to fit the public web structure.
  # Links have the following format:
  # [Some text](/the/url/)
  #
  # Doc url ==> modified url
  # ------------------------
  # #page-ref ==> #page-ref
  # /my-url/ ==> /docs/repo-name/my-url/
  # https://www.bitcraze.io/fancy_page/ ==> /fancy_page/
  # https://other.domain/fancy_page/ ==> https://other.domain/fancy_page/

  doc.gsub(/(\[[^\[]*\])\(\s*(\/[^\)]*)\)/, '\1(/docs/' + repo_name + '\2)').gsub(/(\[[^\[]*\])\(\s*https:\/\/www.bitcraze.io(\/[^\)]*\))/, '\1\2')
end

def add_name_space_to_node_list(nodes, ns)
  nodes.each do |node|
    if node.key? 'page_id'
      node['page_id'] = ns + node['page_id']
    end

    if node.key? 'subs'
      add_name_space_to_node_list(node['subs'], ns)
    end
  end
end

def add_to_docs_menus(docs_menu_file, shared_docs_menus_file, ns)
  repo_menus = YAML.load_file(docs_menu_file)
  add_name_space_to_node_list(repo_menus, ns)

  if File.file? shared_docs_menus_file
    shared_menus = YAML.load_file(shared_docs_menus_file)
  else
    shared_menus = {}
  end

  shared_menus[ns] = repo_menus

  IO.write(shared_docs_menus_file, shared_menus.to_yaml)
end


docs_dir = ARGV[0]
ns = ARGV[1]
repo_name = ARGV[2]
docs_menu_file = ARGV[3]
shared_docs_menus_file = ARGV[4]

update_docs_content(docs_dir, ns, repo_name)
add_to_docs_menus(docs_menu_file, shared_docs_menus_file, ns)
